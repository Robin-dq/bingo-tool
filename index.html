<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BINGO ツール（安定版）</title>

<!-- Noto Sans JP 太字 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: #eee;
  padding: 20px;
  text-align: center;
}

/* 盤面 */
#board-wrapper {
  position: relative;
  width: 100%;
  max-width: 1448px;
  margin: 0 auto;
  pointer-events: auto;
}

#board-img {
  width: 100%;
  height: auto;
  display: block;
}

/* 盤面の上に被せるレイヤー */
#overlay {
  position: absolute;
  inset: 0;
  pointer-events: none; /* クリックは下のwrapperへ通す */
}

/* マスの文字（JSでサイズ＆位置調整） */
.cell-text {
  position: absolute;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'Noto Sans JP', sans-serif;
  font-weight: 700;
  color: black;
  text-align: center;
  pointer-events: none;
  z-index: 10;
}

/* 名前表示（右下固定） */
#name-display {
  position: absolute;
  right: 20px;
  bottom: 20px;
  font-family: 'Noto Sans JP', sans-serif;
  font-weight: 700;
  color: black;
  z-index: 10;
}

/* 選択枠 */
#selector {
  position: absolute;
  border: 6px solid #FFD500;
  display: none;
  z-index: 20;
}
</style>
</head>
<body>

<h2>BINGO 単語配置ツール</h2>

<div id="board-wrapper">
  <img id="board-img" src="bingo_template.jpg" alt="ビンゴ台紙">
  <div id="overlay">
    <div id="selector"></div>
    <div id="name-display"></div>
  </div>
</div>

<!-- 名前入力欄 -->
<div style="margin-top:16px;">
  <input id="username" type="text"
         placeholder="名前（画像右下に表示）"
         style="font-size:18px;padding:6px;width:260px;">
</div>

<!-- 曲リスト（※今後は 3 曲だけでOKとのことなので 3 曲だけ） -->
<div style="margin-top:16px;">
  <select id="word-list" style="font-size:18px;padding:6px;">
    <option value="">曲を選択</option>
    <option>色彩</option>
    <option>よすが</option>
    <option>パレード</option>
  </select>
</div>

<button id="save-btn"
        style="margin-top:16px;padding:10px 20px;font-size:18px;">
  画像として保存
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// ==== 画像の実寸（px） ====
const IMG_W = 1448;
const IMG_H = 2048;

// マス情報（実寸座標）
const CELL = 222;
const GAP  = 37;
const START_X = 94;
const START_Y = 701;

let scale = 1;
let selected = null;          // {row, col} 直近に選択したマス
const selections = {};        // "row-col" -> 曲名

const img        = document.getElementById("board-img");
const wrapper    = document.getElementById("board-wrapper");
const overlay    = document.getElementById("overlay");
const selector   = document.getElementById("selector");
const wordList   = document.getElementById("word-list");
const saveBtn    = document.getElementById("save-btn");
const username   = document.getElementById("username");
const nameDisp   = document.getElementById("name-display");

// ==== スケール更新（画像の表示幅に合わせる） ====
function updateScale() {
  scale = img.clientWidth / IMG_W;
  applyScaledSizesAndPositions();
}

// すでに配置されたセル・枠・名前を現在の scale に合わせて再配置
function applyScaledSizesAndPositions() {
  const cellSize = CELL * scale;

  // 文字セル
  document.querySelectorAll(".cell-text").forEach(el => {
    const row = Number(el.dataset.row);
    const col = Number(el.dataset.col);

    const x = (START_X + col * (CELL + GAP)) * scale;
    const y = (START_Y + row * (CELL + GAP)) * scale;

    el.style.left = x + "px";
    el.style.top  = y + "px";
    el.style.width  = cellSize + "px";
    el.style.height = cellSize + "px";
    el.style.fontSize = (32 * scale) + "px";
  });

  // 選択枠
  selector.style.width  = cellSize + "px";
  selector.style.height = cellSize + "px";
  if (selected) {
    const x = (START_X + selected.col * (CELL + GAP)) * scale;
    const y = (START_Y + selected.row * (CELL + GAP)) * scale;
    selector.style.left = x + "px";
    selector.style.top  = y + "px";
  }

  // 名前表示のフォントサイズだけ scale
  nameDisp.style.fontSize = (36 * scale) + "px";
}

// 画像読み込み後にスケール計算
img.addEventListener("load", () => {
  updateScale();
  window.addEventListener("resize", updateScale);
});

// ==== タップ処理（click / touch 共通） ====
function handleTap(e) {
  const rect = wrapper.getBoundingClientRect();
  const clickX = (e.clientX - rect.left) / scale;
  const clickY = (e.clientY - rect.top)  / scale;

  const col = Math.floor((clickX - START_X) / (CELL + GAP));
  const row = Math.floor((clickY - START_Y) / (CELL + GAP));

  if (col < 0 || col > 4 || row < 0 || row > 4) return;
  // 中央マス (2,2) は無効
  if (row === 2 && col === 2) return;

  selected = { row, col };

  const x = (START_X + col * (CELL + GAP)) * scale;
  const y = (START_Y + row * (CELL + GAP)) * scale;

  selector.style.left = x + "px";
  selector.style.top  = y + "px";
  selector.style.display = "block";
}

// PC用
wrapper.addEventListener("click", handleTap);

// iPhone / Android 用
wrapper.addEventListener("touchstart", (e) => {
  const t = e.touches[0];
  handleTap({ clientX: t.clientX, clientY: t.clientY });
});

// ==== 曲選択 → セルに文字を配置 ====
wordList.addEventListener("change", () => {
  if (!selected) return;
  if (selected.row === 2 && selected.col === 2) return;

  const word = wordList.value;
  if (!word) return;

  const key = `${selected.row}-${selected.col}`;
  selections[key] = word;

  const cellId = `cell-${key}`;
  let cell = document.getElementById(cellId);

  if (!cell) {
    cell = document.createElement("div");
    cell.id = cellId;
    cell.className = "cell-text";
    cell.dataset.row = selected.row;
    cell.dataset.col = selected.col;
    overlay.appendChild(cell);
  }

  const cellSize = CELL * scale;
  const x = (START_X + selected.col * (CELL + GAP)) * scale;
  const y = (START_Y + selected.row * (CELL + GAP)) * scale;

  cell.style.left = x + "px";
  cell.style.top  = y + "px";
  cell.style.width  = cellSize + "px";
  cell.style.height = cellSize + "px";
  cell.style.fontSize = (32 * scale) + "px";
  cell.textContent = word;
});

// ==== 名前入力 → 右下表示を更新 ====
username.addEventListener("input", () => {
  nameDisp.textContent = username.value.trim();
  // フォントサイズは applyScaledSizesAndPositions ですでに制御
});

// ==== 画像保存（現在表示されている board-wrapper をそのままキャプチャ） ====
saveBtn.addEventListener("click", () => {
  const wasVisible = selector.style.display !== "none";
  // 保存時は選択枠を消しておく（好みで残してもOK）
  selector.style.display = "none";

  html2canvas(document.getElementById("board-wrapper"), {
    useCORS: true,
    scale: 2   // 高解像度で保存
  }).then(canvas => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "bingo.png";
    link.click();

    // 元の状態に戻す
    if (wasVisible) {
      selector.style.display = "block";
    }
  });
});
</script>

</body>
</html>
