<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BINGO 完全版（ズレ修正）</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #eee;
  padding: 20px;
  text-align: center;
}

#board-wrapper {
  position: relative;
  width: 100%;
  max-width: 1448px;
  margin: 0 auto;
}

/* 画像は幅100%で表示 */
#board-img {
  width: 100%;
  height: auto;
  display: block;
}

/* overlay は画像と同じサイズ（transformは使わない） */
#overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;   /* wrapperと同じ幅 */
  height: 100%;  /* wrapperと同じ高さ（画像の高さ） */
  pointer-events: none;
}

/* 曲名テキスト：赤枠と同じ座標に置く */
.cell-text {
  position: absolute;
  width: 222px;
  height: 222px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 32px;
  font-weight: bold;
  color: black;
  text-align: center;
  pointer-events: none;
  z-index: 10;
}

/* 赤枠 */
#selector {
  position: absolute;
  width: 222px;
  height: 222px;
  border: 6px solid red;
  display: none;
  z-index: 20;
}
</style>
</head>
<body>

<h2>BINGO（完全版・ズレ修正版）</h2>

<div id="board-wrapper">
  <img id="board-img" src="bingo_template.jpg">
  <div id="overlay">
    <div id="selector"></div>
  </div>
</div>

<!-- 楽曲リスト（全曲） -->
<select id="word-list" style="margin-top:20px;font-size:20px;padding:6px;">
  <option value="">曲を選択</option>

  <option>色彩</option>
  <option>よすが</option>
  <option>パレード</option>
  <option>プラネタリウム</option>
  <option>アドバルーン</option>
  <option>ハイリープ</option>
  <option>ノクチルカ</option>
  <option>ラルミー</option>
  <option>夢路</option>
  <option>15秒</option>
  <option>上弦</option>
  <option>空ひとつない雲</option>
  <option>世界点</option>
  <option>スノードーム</option>
  <option>ジョバンニの夜</option>
  <option>パトリシア</option>
  <option>水性キャスト</option>
  <option>フラッシュキーパー</option>
  <option>レインカーテン</option>
  <option>祈りうた</option>
  <option>ハナノイロ</option>
  <option>バーチャルボーイ</option>
  <option>花残り月</option>
  <option>面影ワープ</option>
  <option>空の少年</option>
  <option>セラトナ</option>
  <option>雨を待つ</option>
  <option>ハイリープ（再録）</option>
  <option>てのひらのマリー</option>
  <option>細胞キオク</option>
  <option>絵空事</option>
  <option>マイガール</option>
  <option>アンサーソング</option>
  <option>リアルワールド</option>
  <option>アドバルーン（再録）</option>
  <option>モラトリアム</option>
  <option>ゆきのせい</option>
  <option>うつくしい世界</option>
  <option>ぼくなりのおとぎ話</option>
  <option>なないろびより</option>
  <option>透明な世界</option>
  <option>もしもの話</option>
  <option>ウェンディ</option>
  <option>タキオン</option>
  <option>夢の果て</option>
  <option>こたえあわせ</option>
  <option>こだまことだま</option>
  <option>スノードロップ</option>
  <option>ライムツリー</option>
  <option>SN1998A</option>
  <option>ルミナリー</option>
  <option>虚虚実実</option>
  <option>ヒーロー</option>
  <option>深く</option>
  <option>アザレア</option>
  <option>最終前</option>
  <option>スターハンター</option>
  <option>あおのらくがき</option>
  <option>インソムニア</option>
  <option>ポラリス</option>
  <option>ヨルガオ</option>
  <option>エンブレム</option>
  <option>アイシー</option>
  <option>ラストチャプター</option>
  <option>トリックスター</option>
  <option>ソアー</option>
  <option>つぎはぎもよう</option>
  <option>クエスト</option>
  <option>花灯り</option>
  <option>光のない街</option>
  <option>マジックアワー</option>
  <option>クライマックス</option>
  <option>トロイメライ</option>
  <option>星に届くよ</option>
  <option>ぼくと大人とチョコレート</option>
  <option>月の出る丘</option>
  <option>ジルコニア</option>
  <option>初期衝動</option>
  <option>錯月</option>
  <option>果てなきブルー</option>
  <option>星とぼくの座標</option>
  <option>しずく</option>
</select>

<button id="save-btn"
        style="margin-top:20px;padding:10px 20px;font-size:18px;">
  画像として保存
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// ==== 元画像の実寸 ====
const IMG_W = 1448;
const IMG_H = 2048;

// ==== マス座標（元画像上の値）====
const CELL = 222;
const GAP  = 37;
const START_X = 94;
const START_Y = 701;

let scale = 1;      // 表示サイズ / 実寸
let selected = null;

const img      = document.getElementById("board-img");
const wrapper  = document.getElementById("board-wrapper");
const overlay  = document.getElementById("overlay");
const selector = document.getElementById("selector");
const wordList = document.getElementById("word-list");
const saveBtn  = document.getElementById("save-btn");

// 画像表示サイズに応じて scale を更新
function updateScale() {
  scale = img.clientWidth / IMG_W;
}

// 画像読み込み後に scale 計算
img.addEventListener("load", () => {
  updateScale();
  window.addEventListener("resize", updateScale);
});

// 画像の上をクリック → 実座標に変換してマス判定
wrapper.addEventListener("click", (e) => {
  const rect = wrapper.getBoundingClientRect();

  // 画面上のクリック位置（wrapper左上基準の表示座標）
  const clickX_disp = e.clientX - rect.left;
  const clickY_disp = e.clientY - rect.top;

  // 表示座標 → 元画像座標へ変換
  const clickX = clickX_disp / scale;
  const clickY = clickY_disp / scale;

  const col = Math.floor((clickX - START_X) / (CELL + GAP));
  const row = Math.floor((clickY - START_Y) / (CELL + GAP));

  if (col < 0 || col > 4 || row < 0 || row > 4) return;

  // 元画像上のマス左上座標
  const x_base = START_X + col * (CELL + GAP);
  const y_base = START_Y + row * (CELL + GAP);

  // 表示上の座標にスケーリング
  const x = x_base * scale;
  const y = y_base * scale;

  selector.style.left = x + "px";
  selector.style.top  = y + "px";
  selector.style.display = "block";

  selected = { x, y, row, col };
});

// 曲名配置（赤枠と同じ表示座標に置く）
wordList.addEventListener("change", () => {
  if (!selected) return;

  const word = wordList.value;
  if (!word) return;

  const id = `cell-${selected.row}-${selected.col}`;
  let div = document.getElementById(id);

  if (!div) {
    div = document.createElement("div");
    div.id = id;
    div.className = "cell-text";
    overlay.appendChild(div);
  }

  div.style.left = selected.x + "px";
  div.style.top  = selected.y + "px";
  div.textContent = word;
});

// PNG保存（保存時だけ赤枠を消す）
saveBtn.addEventListener("click", () => {
  const wasVisible = selector.style.display !== "none";
  selector.style.display = "none";

  html2canvas(document.querySelector("#board-wrapper"), {
    useCORS: true,
    allowTaint: true,
    scale: 2
  }).then(canvas => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "bingo.png";
    link.click();

    if (wasVisible) {
      selector.style.display = "block";
    }
  });
});
</script>

</body>
</html>
