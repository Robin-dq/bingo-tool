<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BINGOツール（Canvas折返し保存版）</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               "Hiragino Sans", "Hiragino Kaku Gothic ProN",
               "Yu Gothic", Meiryo, sans-serif;
  background: #eee;
  padding: 20px;
  text-align: center;
}

#board-wrapper {
  position: relative;
  max-width: 1448px;
  margin: 0 auto;
}

#board-img {
  width: 100%;
  display: block;
}

#selector {
  position: absolute;
  border: 6px solid #FFD500;
  display: none;
  z-index: 20;
  pointer-events: none;
}

.cell-text {
  position: absolute;
  font-weight: bold;
  color: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
  text-align: center;
  white-space: pre-wrap;
}
</style>
</head>
<body>

<h2>BINGO単語配置ツール（最終Canvas保存完全対応版）</h2>

<div id="board-wrapper">
  <img id="board-img" src="bingo_template.jpg">
  <div id="selector"></div>
</div>

<select id="word-list" style="font-size:18px;padding:6px;margin-top:12px;">
  <option value="">曲を選択</option>
  <option>色彩</option>
  <option>よすが</option>
  <option>パレード</option>
</select>

<br>
<input id="username" type="text"
       placeholder="右下に入れる名前"
       style="font-size:18px;padding:6px;width:260px;margin-top:12px;">

<br>
<button id="save-btn"
        style="margin-top:16px;padding:10px 20px;font-size:18px;">
  PNGとして保存
</button>

<script>
/* 固定サイズ */
const IMG_W = 1448, IMG_H = 2048;
const CELL = 222, GAP = 37;
const START_X = 94, START_Y = 701;

let scale = 1;
let selected = null;
const selections = {};

const img = document.getElementById("board-img");
const wrapper = document.getElementById("board-wrapper");
const selector = document.getElementById("selector");
const wordList = document.getElementById("word-list");
const username = document.getElementById("username");

/* Canvas用 折り返し関数 */
function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight, maxLines = 2) {
  const chars = [...text];
  let line = "";
  let lines = [];

  for (let i = 0; i < chars.length; i++) {
    const testLine = line + chars[i];
    if (ctx.measureText(testLine).width > maxWidth) {
      lines.push(line);
      line = chars[i];
      if (lines.length >= maxLines) break;
    } else {
      line = testLine;
    }
  }
  if (lines.length < maxLines) lines.push(line);

  const totalHeight = lines.length * lineHeight;
  const startY = y - totalHeight / 2 + lineHeight * 0.85;

  for (let i = 0; i < lines.length; i++) {
    ctx.fillText(lines[i], x, startY + i * lineHeight);
  }
}

/* プレビュー更新 */
img.onload = () => updateScale();
window.addEventListener("resize", updateScale);

function updateScale() {
  scale = img.clientWidth / IMG_W;
  updateTexts();
}

function updateTexts() {
  document.querySelectorAll(".cell-text").forEach(el => {
    const r = Number(el.dataset.row);
    const c = Number(el.dataset.col);
    el.style.left = (START_X + c*(CELL+GAP)) * scale + "px";
    el.style.top  = (START_Y + r*(CELL+GAP)) * scale + "px";
    el.style.width  = CELL * scale + "px";
    el.style.height = CELL * scale + "px";
    el.style.fontSize = (36 * scale) + "px";
  });

  if (selected) {
    selector.style.left = (START_X + selected.col*(CELL+GAP)) * scale + "px";
    selector.style.top  = (START_Y + selected.row*(CELL+GAP)) * scale + "px";
    selector.style.width = CELL * scale + "px";
    selector.style.height = CELL * scale + "px";
  }
}

/* タップ処理 */
function handleTap(e) {
  const rect = wrapper.getBoundingClientRect();
  const x = (e.clientX - rect.left) / scale;
  const y = (e.clientY - rect.top) / scale;

  const col = Math.floor((x - START_X) / (CELL + GAP));
  const row = Math.floor((y - START_Y) / (CELL + GAP));

  if (col < 0 || col > 4 || row < 0 || row > 4) return;
  if (row === 2 && col === 2) return; // FREE無効

  selected = { row, col };

  selector.style.display = "block";
  selector.style.left = (START_X + col*(CELL+GAP)) * scale + "px";
  selector.style.top  = (START_Y + row*(CELL+GAP)) * scale + "px";
  selector.style.width = CELL * scale + "px";
  selector.style.height = CELL * scale + "px";
}

wrapper.addEventListener("click", handleTap);
wrapper.addEventListener("touchstart", e => {
  const t = e.touches[0];
  handleTap({ clientX: t.clientX, clientY: t.clientY });
});

/* 曲選択 */
wordList.onchange = () => {
  if (!selected) return;

  const key = `${selected.row}-${selected.col}`;
  selections[key] = wordList.value;

  let el = document.getElementById("cell-" + key);
  if (!el) {
    el = document.createElement("div");
    el.className = "cell-text";
    el.id = "cell-" + key;
    el.dataset.row = selected.row;
    el.dataset.col = selected.col;
    wrapper.appendChild(el);
  }

  el.innerText = wordList.value;
  updateTexts();
};

/* PNG保存（Canvas） */
document.getElementById("save-btn").onclick = async () => {

  // Canvas作成
  const canvas = document.createElement("canvas");
  canvas.width = IMG_W;
  canvas.height = IMG_H;
  const ctx = canvas.getContext("2d");

  // 背景画像ロード
  const bg = new Image();
  bg.crossOrigin = "anonymous";
  bg.src = "bingo_template.jpg";
  await new Promise(res => bg.onload = res);

  // 背景描画
  ctx.drawImage(bg, 0, 0, IMG_W, IMG_H);

  // 文字描画
  ctx.font = "bold 36px sans-serif";
  ctx.fillStyle = "#000";
  ctx.textAlign = "center";

  for (const key in selections) {
    const [r, c] = key.split("-").map(Number);
    const txt = selections[key];

    const x = START_X + c*(CELL+GAP) + CELL/2;
    const y = START_Y + r*(CELL+GAP) + CELL/2;

    drawWrappedText(ctx, txt, x, y, CELL - 20, 40, 2);
  }

  // 名前描画（右下）
  const name = username.value.trim();
  if (name) {
    ctx.textAlign = "right";
    ctx.fillText(name, IMG_W - 30, IMG_H - 30);
  }

  // 保存
  const url = canvas.toDataURL("image/png");
  const link = document.createElement("a");
  link.href = url;
  link.download = "bingo.png";
  link.click();
};
</script>

</body>
</html>
